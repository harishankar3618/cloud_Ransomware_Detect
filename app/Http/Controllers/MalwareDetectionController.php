<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Symfony\Component\Process\Exception\ProcessFailedException;
use Symfony\Component\Process\Process;
use Illuminate\Support\Facades\Log;

class MalwareDetectionController extends Controller
{
    public function welcome()
    {
        return view('welcome');
    }

    public function detectMalware(Request $request)
    {
        $request->validate([
            'uploads' => 'required',
            'uploads.*' => 'file|max:102400', // max 100MB
            'receipt_email' => 'required|email'
        ]);

        $uploadedFiles = $request->file('uploads');
        $receiptEmail = $request->input('receipt_email');
        $uploadType = $request->input('fileOrFolder', 'file');

        // âœ… Set correct Python path based on OS
        $pythonCmd = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN'
            ? 'C:\\Python313\\python.exe'
            : 'python3';

        $pythonScriptPath = base_path('Project/scan_file.py');
        $emailScriptPath = base_path('Project/email_alert.py');
        $results = [];

        $uploadsFolderPath = storage_path('app/private/uploads');
        if (!file_exists($uploadsFolderPath)) {
            mkdir($uploadsFolderPath, 0755, true);
        }

        try {
            if ($uploadType === 'folder') {
                $folderPath = $uploadsFolderPath . '/uploads_folder_' . time();
                mkdir($folderPath, 0755, true);

                foreach ($uploadedFiles as $file) {
                    $file->move($folderPath, $file->getClientOriginalName());
                }

                $process = new Process([$pythonCmd, $pythonScriptPath, 'folder', $folderPath]);
                $process->setTimeout(300);
                $process->run();

                if (!$process->isSuccessful()) {
                    Log::error('Python script failed: ' . $process->getErrorOutput());
                    $results[] = [
                        'file' => 'Folder: uploads_folder',
                        'output' => 'Scan failed: ' . $process->getErrorOutput(),
                        'error' => $process->getErrorOutput()
                    ];
                } else {
                    $results[] = [
                        'file' => 'Folder: uploads_folder',
                        'output' => $process->getOutput(),
                    ];
                }

                $this->cleanupDirectory($folderPath);
            } else {
                foreach ($uploadedFiles as $file) {
                    $fileName = time() . '_' . $file->getClientOriginalName();
                    $storedPath = $file->storeAs('private/uploads', $fileName);
                    $fullPath = storage_path("app/$storedPath");

                    $process = new Process([$pythonCmd, $pythonScriptPath, 'file', $fullPath]);
                    $process->setTimeout(120);
                    $process->run();

                    if (!$process->isSuccessful()) {
                        Log::error('Python script failed for file ' . $file->getClientOriginalName() . ': ' . $process->getErrorOutput());
                        $results[] = [
                            'file' => $file->getClientOriginalName(),
                            'output' => 'Scan failed: ' . $process->getErrorOutput(),
                            'error' => $process->getErrorOutput()
                        ];
                    } else {
                        $results[] = [
                            'file' => $file->getClientOriginalName(),
                            'output' => $process->getOutput(),
                        ];
                    }

                    if (file_exists($fullPath)) {
                        unlink($fullPath);
                    }
                }
            }

            Log::info('Scan results:', $results);

            if (!empty($results)) {
                $this->sendEmailResults($results, $receiptEmail, $emailScriptPath, $pythonCmd);
            }

        } catch (\Exception $e) {
            Log::error('Malware scan failed: ' . $e->getMessage());
            return back()->with('error', 'Something went wrong during the scan: ' . $e->getMessage())
                         ->withInput();
        }

        return view('welcome', [
            'results' => $results,
            'scan_completed' => true
        ])->with('success', 'Scan completed successfully!');
    }

    private function sendEmailResults($results, $receiptEmail, $emailScriptPath, $pythonCmd)
    {
        try {
            $resultsString = "";
            foreach ($results as $result) {
                $resultsString .= "File/Folder: " . $result['file'] . "\nOutput: " . $result['output'] . "\n\n";
            }

            $emailProcess = new Process([$pythonCmd, $emailScriptPath, $resultsString, $receiptEmail]);
            $emailProcess->setTimeout(60);
            $emailProcess->run();

            if (!$emailProcess->isSuccessful()) {
                Log::warning('Email sending failed: ' . $emailProcess->getErrorOutput());
            }
        } catch (\Exception $e) {
            Log::warning('Email sending failed: ' . $e->getMessage());
        }
    }

    private function cleanupDirectory($directory)
    {
        if (is_dir($directory)) {
            $files = glob($directory . '/*');
            foreach ($files as $file) {
                if (is_file($file)) {
                    unlink($file);
                }
            }
            rmdir($directory);
        }
    }

    public function scanIp(Request $request)
    {
        $request->validate([
            'ip_address' => 'required|ip',
        ]);

        $ipAddress = $request->input('ip_address');
        $ipScanScript = base_path('Project/ip_scan.py');
        $pythonCmd = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN'
            ? 'C:\\Python313\\python.exe'
            : 'python3';

        try {
            $process = new Process([$pythonCmd, $ipScanScript, $ipAddress]);
            $process->setTimeout(60);
            $process->run();

            if (!$process->isSuccessful()) {
                throw new ProcessFailedException($process);
            }

            $ipResults = json_decode($process->getOutput(), true);
            Log::info('IP scan results:', ['results' => $ipResults]);

        } catch (\Exception $e) {
            Log::error('IP scan failed: ' . $e->getMessage());
            return back()->with('error', 'IP scanning failed: ' . $e->getMessage());
        }

        return view('welcome', compact('ipResults'));
    }
}
